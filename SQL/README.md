# SQLç›®å½•æ€»è§ˆ

æœ¬ç›®å½•åŒ…å«å†…åœ¨å®‡å®™é¡¹ç›®çš„å®Œæ•´æ•°æ®åº“è®¾è®¡æ–¹æ¡ˆå’Œæ“ä½œæŒ‡å—ã€‚

## ğŸ“ æ–‡ä»¶ç»“æ„

```
sql/
â”œâ”€â”€ README.md                           # æœ¬æ–‡æ¡£
â”œâ”€â”€ DATABASE_DESIGN.md                  # æ•°æ®åº“è®¾è®¡æ–¹æ¡ˆ
â”œâ”€â”€ DATA_COLLECTION_GUIDELINES.md      # æ•°æ®æ”¶é›†å­˜å‚¨æ³¨æ„äº‹é¡¹
â”œâ”€â”€ models.ts                          # Mongooseæ•°æ®æ¨¡å‹å®šä¹‰
â”œâ”€â”€ database_operations.ts             # æ•°æ®åº“æ“ä½œç¤ºä¾‹å’Œæœ€ä½³å®è·µ
â”œâ”€â”€ init_database.sh                   # æ•°æ®åº“åˆå§‹åŒ–è„šæœ¬
â””â”€â”€ migrations/                        # æ•°æ®åº“è¿ç§»æ–‡ä»¶ï¼ˆæœªæ¥æ‰©å±•ï¼‰
```

## ğŸ¯ æ ¸å¿ƒæ–‡æ¡£è¯´æ˜

### 1. DATABASE_DESIGN.md
**å®Œæ•´çš„æ•°æ®åº“è®¾è®¡æ–¹æ¡ˆ**
- æ•°æ®åº“é€‰æ‹©ï¼šMongoDB + Redis
- æ•°æ®æ¨¡å‹è®¾è®¡ï¼šç”¨æˆ·ã€æµ‹è¯•ç»“æœã€AIåˆ†æã€ç”¨æˆ·ä¼šè¯ã€ç³»ç»Ÿé…ç½®
- ç´¢å¼•ä¼˜åŒ–ç­–ç•¥
- åˆ†ç‰‡å’Œæ€§èƒ½ä¼˜åŒ–
- æ•°æ®å…³ç³»è®¾è®¡

### 2. DATA_COLLECTION_GUIDELINES.md
**æ•°æ®æ”¶é›†å­˜å‚¨æ³¨æ„äº‹é¡¹**
- æ•°æ®éšç§ä¸å®‰å…¨
- æ•°æ®æ”¶é›†è§„èŒƒ
- å­˜å‚¨å®‰å…¨è¦æ±‚
- æ•°æ®è´¨é‡ç®¡ç†
- åˆè§„æ€§è¦æ±‚ï¼ˆGDPRç­‰ï¼‰
- æœ€ä½³å®è·µæ€»ç»“

### 3. models.ts
**Mongooseæ•°æ®æ¨¡å‹å®šä¹‰**
- å®Œæ•´çš„TypeScriptæ¥å£å®šä¹‰
- Mongoose Schemaé…ç½®
- æ•°æ®éªŒè¯è§„åˆ™
- ä¸­é—´ä»¶å’Œå®ä¾‹æ–¹æ³•
- ç´¢å¼•å®šä¹‰

### 4. database_operations.ts
**æ•°æ®åº“æ“ä½œç¤ºä¾‹å’Œæœ€ä½³å®è·µ**
- ç”¨æˆ·ç®¡ç†æ“ä½œ
- æµ‹è¯•ç»“æœå¤„ç†
- AIåˆ†æç®¡ç†
- æ‰¹é‡æ“ä½œ
- èšåˆæŸ¥è¯¢
- äº‹åŠ¡å¤„ç†
- æ€§èƒ½ä¼˜åŒ–

### 5. init_database.sh
**æ•°æ®åº“åˆå§‹åŒ–è„šæœ¬**
- è‡ªåŠ¨åŒ–æ•°æ®åº“åˆ›å»º
- ç´¢å¼•åˆ›å»º
- ç³»ç»Ÿé…ç½®åˆå§‹åŒ–
- ç®¡ç†å‘˜è´¦æˆ·åˆ›å»º
- æ•°æ®å®Œæ•´æ€§éªŒè¯

## ğŸš€ å¿«é€Ÿå¼€å§‹

### 1. æ•°æ®åº“åˆå§‹åŒ–
```bash
# è®¾ç½®ç¯å¢ƒå˜é‡
export MONGODB_URI="mongodb://localhost:27017"
export ADMIN_EMAIL="admin@inner-cosmos.com"
export ADMIN_PASSWORD="your-secure-password"

# è¿è¡Œåˆå§‹åŒ–è„šæœ¬
./init_database.sh
```

### 2. åœ¨é¡¹ç›®ä¸­ä½¿ç”¨
```typescript
// å¯¼å…¥æ•°æ®æ¨¡å‹
import { User, TestResult, AIAnalysis } from './sql/models';

// å¯¼å…¥æœåŠ¡ç±»
import { UserService, TestResultService } from './sql/database_operations';

// åˆ›å»ºç”¨æˆ·
const user = await UserService.createUser({
  email: 'user@example.com',
  username: 'testuser',
  password: 'password123'
});

// åˆ›å»ºæµ‹è¯•
const test = await TestResultService.createTestResult({
  userId: user._id,
  testType: 'mbti',
  testVersion: '1.0.0'
});
```

## ğŸ“Š æ•°æ®æ¨¡å‹æ¦‚è¿°

### æ ¸å¿ƒæ•°æ®æ¨¡å‹
1. **User** - ç”¨æˆ·ä¿¡æ¯
   - åŸºç¡€ä¿¡æ¯ã€ä¸ªäººæ¡£æ¡ˆã€åå¥½è®¾ç½®
   - è´¦æˆ·çŠ¶æ€ã€å®‰å…¨ä¿¡æ¯ã€å…ƒæ•°æ®

2. **TestResult** - æµ‹è¯•ç»“æœ
   - æµ‹è¯•æ•°æ®ã€ç»“æœåˆ†æã€ç¯å¢ƒä¿¡æ¯
   - çŠ¶æ€ç®¡ç†ã€ç»Ÿè®¡æ•°æ®

3. **AIAnalysis** - AIåˆ†æ
   - åˆ†æå†…å®¹ã€è´¨é‡æŒ‡æ ‡ã€ä½¿ç”¨ç»Ÿè®¡
   - æŠ€æœ¯ä¿¡æ¯ã€æˆæœ¬è·Ÿè¸ª

4. **UserSession** - ç”¨æˆ·ä¼šè¯
   - èŠå¤©è®°å½•ã€ä¼šè¯çŠ¶æ€ã€ç»Ÿè®¡ä¿¡æ¯
   - æ¶ˆæ¯ç®¡ç†ã€é™„ä»¶å¤„ç†

5. **SystemConfig** - ç³»ç»Ÿé…ç½®
   - æµ‹è¯•é…ç½®ã€AIé…ç½®ã€ç³»ç»Ÿè®¾ç½®
   - ç‰ˆæœ¬ç®¡ç†ã€ç¯å¢ƒé…ç½®

### æ•°æ®å…³ç³»
```
User (1:N) TestResult
User (1:N) AIAnalysis  
User (1:N) UserSession
TestResult (1:N) AIAnalysis
```

## ğŸ”§ æŠ€æœ¯æ ˆ

### æ•°æ®åº“
- **MongoDB 6.0+** - ä¸»æ•°æ®åº“
- **Redis 7.0+** - ç¼“å­˜å±‚
- **Mongoose 7.0+** - ODMæ¡†æ¶

### ç‰¹æ€§
- âœ… å®Œæ•´çš„TypeScriptæ”¯æŒ
- âœ… æ•°æ®éªŒè¯å’Œçº¦æŸ
- âœ… ç´¢å¼•ä¼˜åŒ–
- âœ… äº‹åŠ¡æ”¯æŒ
- âœ… èšåˆæŸ¥è¯¢
- âœ… æ€§èƒ½ä¼˜åŒ–
- âœ… å®‰å…¨é˜²æŠ¤

## ğŸ“ˆ æ€§èƒ½ä¼˜åŒ–

### 1. ç´¢å¼•ç­–ç•¥
- å•å­—æ®µç´¢å¼•ï¼šemail, username
- å¤åˆç´¢å¼•ï¼šuserId + testType + completedAt
- æ–‡æœ¬ç´¢å¼•ï¼šåˆ†æå†…å®¹æœç´¢
- åœ°ç†ç´¢å¼•ï¼šä½ç½®ä¿¡æ¯æŸ¥è¯¢

### 2. æŸ¥è¯¢ä¼˜åŒ–
- ä½¿ç”¨lean()æé«˜æŸ¥è¯¢æ€§èƒ½
- èšåˆç®¡é“ä¼˜åŒ–
- åˆ†é¡µæŸ¥è¯¢ä¼˜åŒ–
- ç¼“å­˜çƒ­ç‚¹æ•°æ®

### 3. å­˜å‚¨ä¼˜åŒ–
- æ•°æ®å‹ç¼©
- åˆ†ç‰‡é…ç½®
- è¯»å†™åˆ†ç¦»
- è¿æ¥æ± ç®¡ç†

## ğŸ›¡ï¸ å®‰å…¨æªæ–½

### 1. æ•°æ®å®‰å…¨
- å¯†ç å“ˆå¸Œå­˜å‚¨
- æ•æ„Ÿä¿¡æ¯åŠ å¯†
- APIè®¿é—®æ§åˆ¶
- è¯·æ±‚é™æµ

### 2. éšç§ä¿æŠ¤
- æ•°æ®åŒ¿ååŒ–
- ç”¨æˆ·æˆæƒç®¡ç†
- æ•°æ®è®¿é—®å®¡è®¡
- GDPRåˆè§„

### 3. ç³»ç»Ÿå®‰å…¨
- è¿æ¥åŠ å¯†
- å‚æ•°éªŒè¯
- æ³¨å…¥é˜²æŠ¤
- å¼‚å¸¸å¤„ç†

## ğŸ“‹ å¼€å‘æŒ‡å—

### 1. æ•°æ®æ¨¡å‹æ‰©å±•
```typescript
// æ‰©å±•ç°æœ‰æ¨¡å‹
interface ExtendedUser extends IUser {
  customField: string;
}

// æ·»åŠ æ–°çš„æ¨¡å‹
const CustomSchema = new Schema({
  // å­—æ®µå®šä¹‰
});
```

### 2. æ·»åŠ æ–°çš„æ“ä½œ
```typescript
// ç»§æ‰¿ç°æœ‰æœåŠ¡
class CustomUserService extends UserService {
  static async customOperation() {
    // è‡ªå®šä¹‰æ“ä½œ
  }
}
```

### 3. æ•°æ®è¿ç§»
```bash
# åˆ›å»ºè¿ç§»æ–‡ä»¶
./init_database.sh --migration create_new_field

# è¿è¡Œè¿ç§»
./init_database.sh --migration up
```

## ğŸ” ç›‘æ§ä¸ç»´æŠ¤

### 1. æ€§èƒ½ç›‘æ§
- æ…¢æŸ¥è¯¢æ—¥å¿—
- è¿æ¥æ± çŠ¶æ€
- å†…å­˜ä½¿ç”¨æƒ…å†µ
- ç´¢å¼•æ•ˆç‡åˆ†æ

### 2. æ•°æ®æ¸…ç†
- è¿‡æœŸæ•°æ®æ¸…ç†
- ç´¢å¼•ç¢ç‰‡æ•´ç†
- æ—¥å¿—è½®è½¬
- å¤‡ä»½éªŒè¯

### 3. å¥åº·æ£€æŸ¥
```javascript
// æ•°æ®åº“å¥åº·æ£€æŸ¥
const healthCheck = async () => {
  const dbStatus = await mongoose.connection.db.admin().ping();
  const userCount = await User.countDocuments();
  const testCount = await TestResult.countDocuments();
  
  return {
    database: dbStatus ? 'healthy' : 'unhealthy',
    users: userCount,
    tests: testCount,
    timestamp: new Date()
  };
};
```

## ğŸ†˜ æ•…éšœæ’é™¤

### å¸¸è§é—®é¢˜

1. **è¿æ¥è¶…æ—¶**
   - æ£€æŸ¥MongoDBæœåŠ¡çŠ¶æ€
   - éªŒè¯è¿æ¥å­—ç¬¦ä¸²
   - æ£€æŸ¥ç½‘ç»œè¿æ¥

2. **ç´¢å¼•é—®é¢˜**
   - é‡å»ºç´¢å¼•ï¼š`db.collection.reIndex()`
   - æŸ¥çœ‹ç´¢å¼•ä½¿ç”¨ï¼š`db.collection.getIndexes()`
   - åˆ†ææŸ¥è¯¢è®¡åˆ’ï¼š`query.explain()`

3. **æ€§èƒ½é—®é¢˜**
   - å¯ç”¨æ…¢æŸ¥è¯¢æ—¥å¿—
   - ä¼˜åŒ–æŸ¥è¯¢æ¡ä»¶
   - è°ƒæ•´ç´¢å¼•ç­–ç•¥

### è·å–å¸®åŠ©
- æŸ¥çœ‹MongoDBå®˜æ–¹æ–‡æ¡£
- æ£€æŸ¥Mongooseæ–‡æ¡£
- è”ç³»æŠ€æœ¯æ”¯æŒå›¢é˜Ÿ

---

**æ³¨æ„äº‹é¡¹ï¼š**
- ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²å‰è¯·åŠ¡å¿…æµ‹è¯•æ‰€æœ‰åŠŸèƒ½
- å®šæœŸå¤‡ä»½æ•°æ®åº“
- ä¿æŒæ•°æ®åº“å’Œä¾èµ–é¡¹çš„æ›´æ–°
- éµå®ˆç›¸å…³çš„æ•°æ®ä¿æŠ¤æ³•è§„

**ç‰ˆæœ¬ä¿¡æ¯ï¼š**
- è®¾è®¡ç‰ˆæœ¬ï¼š1.0.0
- æœ€åæ›´æ–°ï¼š2025-01-10
- å…¼å®¹æ€§ï¼šMongoDB 6.0+, Node.js 18+