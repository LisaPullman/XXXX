# è¯­éŸ³æ’­æ”¾æ§åˆ¶ä¿®å¤è¯´æ˜

## ğŸ¯ é—®é¢˜æè¿°

åœ¨å…«å¦ç®—è¿é¡µé¢ `http://localhost:5173/bagua/ai-divination` ä¸­ï¼Œæ§åˆ¶å£°éŸ³æ’­æ”¾çš„æŒ‰é’®æ— æ³•ç»ˆæ­¢å£°éŸ³çš„æ’­æ”¾ã€‚ç”¨æˆ·ç‚¹å‡»åœæ­¢æŒ‰é’®åï¼ŒéŸ³é¢‘ä»ç„¶ç»§ç»­æ’­æ”¾ï¼Œé€ æˆä¸è‰¯çš„ç”¨æˆ·ä½“éªŒã€‚

### é—®é¢˜åŸå› åˆ†æ

1. **ç¼ºå°‘éŸ³é¢‘å¯¹è±¡å¼•ç”¨**: åŸå§‹å®ç°æ²¡æœ‰ä¿å­˜ `HTMLAudioElement` å¯¹è±¡çš„å¼•ç”¨
2. **æ— æ³•è°ƒç”¨åœæ­¢æ–¹æ³•**: æ²¡æœ‰ `pause()` å’Œ `currentTime = 0` çš„è°ƒç”¨
3. **å†…å­˜æ³„æ¼é£é™©**: éŸ³é¢‘URLæ²¡æœ‰æ­£ç¡®é‡Šæ”¾
4. **çŠ¶æ€ä¸åŒæ­¥**: UIçŠ¶æ€ä¸å®é™…æ’­æ”¾çŠ¶æ€ä¸ä¸€è‡´

## âœ… è§£å†³æ–¹æ¡ˆ

### 1. é‡æ„ SiliconFlowService éŸ³é¢‘ç®¡ç†

#### æ·»åŠ éŸ³é¢‘å¯¹è±¡å¼•ç”¨ç®¡ç†
```typescript
class SiliconFlowService {
  private currentAudio: HTMLAudioElement | null = null;
  private currentAudioUrl: string | null = null;
  
  // åœæ­¢å½“å‰æ’­æ”¾çš„éŸ³é¢‘
  stopCurrentAudio(): void {
    if (this.currentAudio) {
      this.currentAudio.pause();
      this.currentAudio.currentTime = 0;
      this.currentAudio = null;
    }
    
    if (this.currentAudioUrl) {
      URL.revokeObjectURL(this.currentAudioUrl);
      this.currentAudioUrl = null;
    }
  }
  
  // æ£€æŸ¥æ’­æ”¾çŠ¶æ€
  isPlaying(): boolean {
    return this.currentAudio !== null && !this.currentAudio.paused;
  }
}
```

#### æ”¹è¿›éŸ³é¢‘æ’­æ”¾æ–¹æ³•
```typescript
async playAudio(audioBlob: Blob): Promise<void> {
  // åœæ­¢å½“å‰æ’­æ”¾çš„éŸ³é¢‘
  this.stopCurrentAudio();
  
  const audioUrl = URL.createObjectURL(audioBlob);
  const audio = new Audio(audioUrl);
  
  // ä¿å­˜å¼•ç”¨ä»¥ä¾¿æ§åˆ¶
  this.currentAudio = audio;
  this.currentAudioUrl = audioUrl;
  
  // æ’­æ”¾ç»“æŸæˆ–å‡ºé”™æ—¶è‡ªåŠ¨æ¸…ç†
  audio.onended = () => {
    if (this.currentAudio === audio) {
      this.currentAudio = null;
    }
    if (this.currentAudioUrl === audioUrl) {
      URL.revokeObjectURL(audioUrl);
      this.currentAudioUrl = null;
    }
  };
}
```

#### å¢å¼º speakAsWiseMaster è¿”å›å€¼
```typescript
async speakAsWiseMaster(text: string, options = {}): Promise<{
  audioBlob: Blob;
  play: () => Promise<void>;
  stop: () => void;  // æ–°å¢åœæ­¢æ–¹æ³•
}> {
  // ... å¤„ç†é€»è¾‘
  
  return {
    audioBlob,
    play: playFunction,
    stop: () => this.stopCurrentAudio()  // è¿”å›åœæ­¢æ–¹æ³•
  };
}
```

### 2. ä¼˜åŒ– BaguaAIDivinationPage æ§åˆ¶é€»è¾‘

#### æ”¹è¿›åœæ­¢åŠŸèƒ½
```typescript
// åœæ­¢å½“å‰æ’­æ”¾
const stopCurrentVoice = () => {
  try {
    // è°ƒç”¨æœåŠ¡çš„åœæ­¢æ–¹æ³•
    siliconFlowService.stopCurrentAudio();
  } catch (error) {
    console.error('åœæ­¢è¯­éŸ³æ’­æ”¾å¤±è´¥:', error);
  } finally {
    setIsPlaying(false);
    setCurrentPlayingId(null);
  }
};
```

#### æ·»åŠ å•ç‹¬æ’­æ”¾æ§åˆ¶
```typescript
// å•ç‹¬æ’­æ”¾æ¶ˆæ¯è¯­éŸ³
const playMessageVoice = async (text: string, messageId: string) => {
  if (isPlaying) {
    // å¦‚æœæ­£åœ¨æ’­æ”¾åŒä¸€æ¡æ¶ˆæ¯ï¼Œåˆ™åœæ­¢
    if (currentPlayingId === messageId) {
      stopCurrentVoice();
      return;
    }
    // å¦‚æœæ­£åœ¨æ’­æ”¾å…¶ä»–æ¶ˆæ¯ï¼Œå…ˆåœæ­¢
    stopCurrentVoice();
  }
  
  // ... æ’­æ”¾é€»è¾‘
};
```

#### çŠ¶æ€åŒæ­¥æœºåˆ¶
```typescript
// å®šæœŸæ£€æŸ¥æ’­æ”¾çŠ¶æ€ï¼Œç¡®ä¿UIçŠ¶æ€ä¸å®é™…æ’­æ”¾çŠ¶æ€åŒæ­¥
useEffect(() => {
  const checkPlayingStatus = () => {
    const actuallyPlaying = siliconFlowService.isPlaying();
    if (!actuallyPlaying && isPlaying) {
      setIsPlaying(false);
      setCurrentPlayingId(null);
    }
  };

  const interval = setInterval(checkPlayingStatus, 1000);
  return () => clearInterval(interval);
}, [isPlaying]);
```

### 3. æ”¹è¿›ç”¨æˆ·ç•Œé¢

#### æ’­æ”¾æŒ‰é’®çŠ¶æ€ä¼˜åŒ–
```typescript
<button
  onClick={() => playMessageVoice(message.content, messageId)}
  className={`${
    currentPlayingId === messageId
      ? 'bg-red-500 text-white animate-pulse hover:bg-red-600'  // æ’­æ”¾ä¸­æ˜¾ç¤ºçº¢è‰²
      : 'hover:bg-amber-500 hover:text-white'  // æœªæ’­æ”¾æ˜¾ç¤ºé»˜è®¤è‰²
  }`}
  title={
    currentPlayingId === messageId 
      ? 'ç‚¹å‡»åœæ­¢æ’­æ”¾'   // æ’­æ”¾ä¸­æç¤ºåœæ­¢
      : 'æ’­æ”¾è¯­éŸ³'       // æœªæ’­æ”¾æç¤ºæ’­æ”¾
  }
>
  {currentPlayingId === messageId ? 'â¹ï¸' : 'â–¶ï¸'}
</button>
```

#### å…¨å±€åœæ­¢æŒ‰é’®
```typescript
{isPlaying && (
  <button
    onClick={stopCurrentVoice}
    className="bg-red-500 text-white hover:bg-red-600"
    title="åœæ­¢æ’­æ”¾"
  >
    â¹ï¸ åœæ­¢æ’­æ”¾
  </button>
)}
```

## ğŸ§ª æµ‹è¯•éªŒè¯

### åˆ›å»ºæµ‹è¯•ç»„ä»¶
åˆ›å»ºäº† `AudioControlTest.tsx` ç»„ä»¶ç”¨äºæµ‹è¯•éŸ³é¢‘æ§åˆ¶åŠŸèƒ½ï¼š

```typescript
// æµ‹è¯•ä¸åŒé•¿åº¦çš„æ–‡æœ¬æ’­æ”¾
const testTexts = [
  'çŸ­æ–‡æœ¬æµ‹è¯•',
  'ä¸­ç­‰é•¿åº¦çš„æ–‡æœ¬æµ‹è¯•ï¼Œç”¨æ¥éªŒè¯æ’­æ”¾æ§åˆ¶',
  'è¿™æ˜¯ä¸€æ®µè¾ƒé•¿çš„æµ‹è¯•æ–‡æœ¬ï¼Œç”¨æ¥éªŒè¯éŸ³é¢‘æ’­æ”¾å’Œåœæ­¢åŠŸèƒ½æ˜¯å¦æ­£å¸¸å·¥ä½œ...'
];

// æµ‹è¯•æ’­æ”¾å’Œåœæ­¢
const playText = async (text: string, index: number) => {
  if (isPlaying && playingIndex === index) {
    stopAudio();  // åŒä¸€ä¸ªæ–‡æœ¬å†æ¬¡ç‚¹å‡»åˆ™åœæ­¢
    return;
  }
  // ... æ’­æ”¾é€»è¾‘
};
```

### æµ‹è¯•åœºæ™¯è¦†ç›–

1. **åŸºæœ¬æ’­æ”¾åœæ­¢**: âœ… æ’­æ”¾éŸ³é¢‘åèƒ½æ­£ç¡®åœæ­¢
2. **åˆ‡æ¢æ’­æ”¾**: âœ… æ’­æ”¾æ–°éŸ³é¢‘æ—¶è‡ªåŠ¨åœæ­¢å½“å‰éŸ³é¢‘
3. **çŠ¶æ€åŒæ­¥**: âœ… UIçŠ¶æ€ä¸å®é™…æ’­æ”¾çŠ¶æ€ä¿æŒä¸€è‡´
4. **å†…å­˜ç®¡ç†**: âœ… éŸ³é¢‘URLæ­£ç¡®é‡Šæ”¾ï¼Œæ— å†…å­˜æ³„æ¼
5. **é”™è¯¯å¤„ç†**: âœ… æ’­æ”¾å¤±è´¥æ—¶æ­£ç¡®æ¸…ç†çŠ¶æ€
6. **ç”¨æˆ·ä½“éªŒ**: âœ… æŒ‰é’®çŠ¶æ€æ¸…æ™°ï¼Œæ“ä½œåé¦ˆåŠæ—¶

## ğŸ“Š ä¿®å¤æ•ˆæœå¯¹æ¯”

### ä¿®å¤å‰ âŒ
- ç‚¹å‡»åœæ­¢æŒ‰é’®æ— æ•ˆæœ
- éŸ³é¢‘ç»§ç»­æ’­æ”¾åˆ°ç»“æŸ
- æ— æ³•ä¸­æ–­é•¿éŸ³é¢‘
- UIçŠ¶æ€ä¸å®é™…ä¸ç¬¦
- å¯èƒ½å­˜åœ¨å†…å­˜æ³„æ¼

### ä¿®å¤å âœ…
- åœæ­¢æŒ‰é’®ç«‹å³ç”Ÿæ•ˆ
- éŸ³é¢‘ç«‹å³åœæ­¢æ’­æ”¾
- å¯éšæ—¶ä¸­æ–­ä»»æ„é•¿åº¦éŸ³é¢‘
- UIçŠ¶æ€å®æ—¶åŒæ­¥
- è‡ªåŠ¨å†…å­˜ç®¡ç†

## ğŸ”§ æŠ€æœ¯å®ç°ç»†èŠ‚

### éŸ³é¢‘å¯¹è±¡ç”Ÿå‘½å‘¨æœŸç®¡ç†
```typescript
// åˆ›å»ºéŸ³é¢‘å¯¹è±¡
const audio = new Audio(audioUrl);
this.currentAudio = audio;

// æ’­æ”¾ç»“æŸè‡ªåŠ¨æ¸…ç†
audio.onended = () => {
  this.cleanup(audio, audioUrl);
};

// æ‰‹åŠ¨åœæ­¢æ¸…ç†
stopCurrentAudio() {
  if (this.currentAudio) {
    this.currentAudio.pause();
    this.currentAudio.currentTime = 0;
    this.cleanup(this.currentAudio, this.currentAudioUrl);
  }
}
```

### çŠ¶æ€ç®¡ç†ä¼˜åŒ–
```typescript
// æ’­æ”¾çŠ¶æ€
const [isPlaying, setIsPlaying] = useState(false);
const [currentPlayingId, setCurrentPlayingId] = useState<string | null>(null);

// çŠ¶æ€åŒæ­¥
useEffect(() => {
  const sync = () => {
    const actualPlaying = siliconFlowService.isPlaying();
    if (actualPlaying !== isPlaying) {
      setIsPlaying(actualPlaying);
      if (!actualPlaying) setCurrentPlayingId(null);
    }
  };
  const interval = setInterval(sync, 1000);
  return () => clearInterval(interval);
}, [isPlaying]);
```

### é”™è¯¯å¤„ç†æœºåˆ¶
```typescript
try {
  await siliconFlowService.speakAsWiseMaster(text, options);
} catch (error) {
  console.error('æ’­æ”¾å¤±è´¥:', error);
} finally {
  // ç¡®ä¿çŠ¶æ€æ­£ç¡®æ¸…ç†
  setIsPlaying(false);
  setCurrentPlayingId(null);
}
```

## ğŸš€ ä½¿ç”¨æ–¹æ³•

### 1. å¯åŠ¨åº”ç”¨æµ‹è¯•
```bash
cd inner-cosmos
pnpm run dev
```

### 2. è®¿é—®å…«å¦ç®—è¿é¡µé¢
```
http://localhost:5173/bagua/ai-divination
```

### 3. æµ‹è¯•éŸ³é¢‘æ§åˆ¶
1. å¼€å¯è¯­éŸ³æ’­æŠ¥å¼€å…³
2. å¼€å§‹ä¸æ™ºè€…å¯¹è¯
3. åœ¨æ™ºè€…å›å¤æ—¶ç‚¹å‡»åœæ­¢æŒ‰é’®
4. éªŒè¯éŸ³é¢‘ç«‹å³åœæ­¢
5. æµ‹è¯•å•ç‹¬æ’­æ”¾æŒ‰é’®çš„åœæ­¢åŠŸèƒ½

### 4. å¼€å‘ç¯å¢ƒæµ‹è¯•
è®¿é—®æµ‹è¯•ç»„ä»¶ï¼ˆä»…å¼€å‘ç¯å¢ƒå¯è§ï¼‰ï¼š
```typescript
import { AudioControlTest } from '@/components/dev/AudioControlTest';
// åœ¨å¼€å‘é¡µé¢ä¸­ä½¿ç”¨
```

## ğŸ“ˆ æ€§èƒ½ä¼˜åŒ–

### å†…å­˜ç®¡ç†
- âœ… è‡ªåŠ¨é‡Šæ”¾éŸ³é¢‘URL
- âœ… æ¸…ç†éŸ³é¢‘å¯¹è±¡å¼•ç”¨
- âœ… é¿å…å†…å­˜æ³„æ¼

### ç”¨æˆ·ä½“éªŒ
- âœ… å³æ—¶å“åº”åœæ­¢æ“ä½œ
- âœ… æ¸…æ™°çš„è§†è§‰åé¦ˆ
- âœ… ä¸€è‡´çš„äº¤äº’é€»è¾‘

### é”™è¯¯æ¢å¤
- âœ… æ’­æ”¾å¤±è´¥è‡ªåŠ¨æ¸…ç†
- âœ… çŠ¶æ€ä¸ä¸€è‡´è‡ªåŠ¨ä¿®å¤
- âœ… ä¼˜é›…çš„é”™è¯¯å¤„ç†

## ğŸ¯ åç»­ä¼˜åŒ–å»ºè®®

1. **éŸ³é‡æ§åˆ¶**: æ·»åŠ éŸ³é‡è°ƒèŠ‚åŠŸèƒ½
2. **æ’­æ”¾è¿›åº¦**: æ˜¾ç¤ºæ’­æ”¾è¿›åº¦æ¡
3. **å¿«è¿›å¿«é€€**: æ”¯æŒéŸ³é¢‘å®šä½
4. **æ’­æ”¾é˜Ÿåˆ—**: æ”¯æŒå¤šéŸ³é¢‘æ’é˜Ÿæ’­æ”¾
5. **ç¦»çº¿ç¼“å­˜**: ç¼“å­˜å¸¸ç”¨éŸ³é¢‘å†…å®¹

---

**ğŸŠ ç°åœ¨è¯­éŸ³æ’­æ”¾æ§åˆ¶åŠŸèƒ½å·²å®Œå…¨ä¿®å¤ï¼ç”¨æˆ·å¯ä»¥éšæ—¶åœæ­¢æ­£åœ¨æ’­æ”¾çš„éŸ³é¢‘ï¼Œè·å¾—å®Œå…¨çš„æ’­æ”¾æ§åˆ¶æƒã€‚**
